<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>मनहरण घनाक्षरी वर्ण गणक</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tiro+Devanagari+Hindi:ital@0;1&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .devanagari {
            font-family: 'Tiro Devanagari Hindi', serif;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-teal-700 devanagari">मनहरण घनाक्षरी वर्ण गणक</h1>
            <p class="text-gray-600 mt-2">अपने घनाक्षरी छंद का विश्लेषण करें। प्रत्येक पद को दो पंक्तियों में लिखें, जहाँ दूसरी पंक्ति यति (विराम) से शुरू होती है।</p>
        </header>

        <main>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <label for="text-input" class="block text-lg font-medium text-gray-700 mb-2 devanagari">घनाक्षरी यहाँ पेस्ट करें:</label>
                <textarea id="text-input" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition duration-200 devanagari text-lg" placeholder="उदाहरण:
लाजनि लपेटि चितवति भेद-भाव-भरी,
लसति ललित लोल चख तिरछानि मैं।
छवि को सदन गोरो भाल बदन रुचिर,
रस निचुरत मीठी मृदु मुसक्यानि मैं॥"></textarea>
                <button id="analyze-btn" class="mt-4 w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-transform transform hover:scale-101 devanagari text-xl">
                    वर्ण गिनें
                </button>
            </div>

            <div id="results-container" class="mt-8">
                <!-- Analysis results will be injected here -->
            </div>
             <!-- Container for the copy button, initially hidden -->
            <div id="copy-container" class="text-center mt-6" style="display: none;">
                <button id="copy-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-101 devanagari text-lg">
                    विश्लेषण टेक्स्ट कॉपी करें
                </button>
                <span id="copy-feedback" class="text-green-600 ml-2 font-semibold" style="display: none;">कॉपी हो गया!</span>
            </div>
            
            <div class="mt-10 p-6 bg-teal-50 border border-teal-200 rounded-xl">
                <h2 class="text-2xl font-bold text-teal-800 devanagari mb-4">मनहरण घनाक्षरी के नियम</h2>
                <ul class="space-y-3 text-gray-700">
                    <li class="flex items-start">
                        <svg class="w-5 h-5 text-teal-500 mr-2 mt-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <span><strong class="font-semibold">कुल वर्ण:</strong> प्रत्येक पद में कुल 31 वर्ण होने चाहिए।</span>
                    </li>
                    <li class="flex items-start">
                         <svg class="w-5 h-5 text-teal-500 mr-2 mt-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <span><strong class="font-semibold">यति विधान:</strong> प्रत्येक पद में 16 और 15 वर्णों पर यति (विराम) अनिवार्य है।</span>
                    </li>
                    <li class="flex items-start">
                         <svg class="w-5 h-5 text-teal-500 mr-2 mt-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <span><strong class="font-semibold">पदांत:</strong> प्रत्येक पद का अंतिम वर्ण गुरु (दीर्घ) होना अनिवार्य है।</span>
                    </li>
                    <li class="flex items-start">
                         <svg class="w-5 h-5 text-teal-500 mr-2 mt-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <span><strong class="font-semibold">वर्ण गणना:</strong> स्वर-रहित (आधे) व्यंजन को वर्ण नहीं माना जाता है। संयुक्त अक्षर (जैसे क्ष, त्र, ज्ञ) को एक ही वर्ण गिना जाता है।</span>
                    </li>
                </ul>
            </div>
            
            <div class="mt-8 p-6 bg-indigo-50 border border-indigo-200 rounded-xl">
                <h2 class="text-2xl font-bold text-indigo-800 devanagari mb-4">तुकांतता (Rhyming) के नियम</h2>
                <ul class="space-y-3 text-gray-700">
                    <li class="flex items-start">
                        <svg class="w-5 h-5 text-indigo-500 mr-2 mt-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <span><strong class="font-semibold">रदीफ़:</strong> पद के अंत में आने वाले समान शब्दों को 'रदीफ़' कहते हैं। तुकांतता की जाँच के लिए इन्हें अलग कर दिया जाता है।</span>
                    </li>
                     <li class="flex items-start">
                        <svg class="w-5 h-5 text-indigo-500 mr-2 mt-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <span><strong class="font-semibold">अमान्य काफ़िया:</strong> एकल स्वर (जैसे 'ई') या एकल अक्षर (जैसे 'यी') मान्य नहीं है। यदि कोई रदीफ़ मौजूद न हो, तो एक लघु स्वर + एक वर्ण (जैसे 'अ' + 'ती' = 'अती') भी अमान्य है।</span>
                    </li>
                     <li class="flex items-start">
                        <svg class="w-5 h-5 text-indigo-500 mr-2 mt-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <span><strong class="font-semibold">मान्य काफ़िया:</strong> एक दीर्घ स्वर + एक वर्ण (जैसे 'आ' + 'ता' = 'आता') या एक से अधिक वर्णों का मेल (जैसे 'निकलती' और 'खिलती' में 'लती') मान्य काफ़िया है।</span>
                    </li>
                </ul>
            </div>
        </main>
    </div>

    <script>
        const analyzeBtn = document.getElementById('analyze-btn');
        const textInput = document.getElementById('text-input');
        const resultsContainer = document.getElementById('results-container');
        const copyContainer = document.getElementById('copy-container');
        const copyBtn = document.getElementById('copy-btn');
        const copyFeedback = document.getElementById('copy-feedback');
        
        // This will hold the structured analysis data to be used for HTML rendering and text generation.
        let analysisData = {};

        // This regex is the core of the varna counting logic.
        const varnaRegex = /(?:[क-ह\u0958-\u095F]़?्)*[क-ह\u0958-\u095F]़?[ा-ौःँं]?|[अ-औ]/g;
        
        const guruVowels = /[आईऊएऐओऔाीूृॄेैोौःं]/;
        const allSwar = /[अ-औ]/;
        const matraMap = {
            'ा': 'आ', 'ि': 'इ', 'ी': 'ई', 'ु': 'उ', 'ू': 'ऊ', 'ृ': 'ऋ', 'ॄ': 'ॠ',
            'े': 'ए', 'ै': 'ऐ', 'ो': 'ओ', 'ौ': 'औ', 'ं': 'अं', 'ः': 'अः', 'ँ': 'अँ'
        };

        function countVarnas(text) {
            const cleanedText = text.replace(/[।,।?!\-]/g, '').trim();
            const matches = cleanedText.match(varnaRegex);
            return matches ? matches.length : 0;
        }

        function getVarnas(text) {
             const cleanedText = text.replace(/[।,।?!\-]/g, '').trim();
             const matches = cleanedText.match(varnaRegex);
             return matches || [];
        }

        function isGuru(varna) {
            if (!varna) return false;
            return guruVowels.test(varna);
        }

        function getVowelOfVarna(varna) {
            if (allSwar.test(varna)) return varna;
            const matra = varna.match(/[ा-ौःँं]/);
            if (matra) return matraMap[matra[0]] || null;
            return 'अ'; // Implicit 'a'
        }

        function validateKaafiya(kaafiya, radeef) {
            if (!kaafiya || kaafiya.length === 0) {
                 return { valid: false, reason: 'काफ़िया शब्दों में कोई सामान्य वर्ण-अंश नहीं है।' };
            }
            const varnasInKaafiya = getVarnas(kaafiya);
            const hasRadeef = radeef && radeef.length > 0;

            if (varnasInKaafiya.length === 1) {
                return { valid: false, reason: `काफ़िया ('${kaafiya}') केवल एक अक्षर है, जो मान्य नहीं है।` };
            }
            const shortVowels = ['अ', 'इ', 'उ', 'ऋ'];
            const firstChar = kaafiya.charAt(0);
            if (allSwar.test(firstChar) && shortVowels.includes(firstChar)) {
                const restOfKaafiya = kaafiya.substring(1);
                const restVarnas = getVarnas(restOfKaafiya);
                if (restVarnas.length === 1) {
                    return hasRadeef ? { valid: true, reason: 'मान्य तुकांतता (रदीफ़ की उपस्थिति के कारण)।' } : { valid: false, reason: `काफ़िया ('${kaafiya}') लघु स्वर + एक अक्षर से बना है और कोई रदीफ़ नहीं है, जो मान्य नहीं है।` };
                }
            }
            return { valid: true, reason: 'मान्य तुकांतता।' };
        }

        function analyzeChhandRhyme(chunk) {
             if (chunk.length < 2) return { overallRhymeStatus: true, results: [] };

            const normalizeForRadeef = (word) => word.replace(/[ं़]/g, '');
            const hindiWordRegex = /[क-हअ-औ]/; 
            const padWords = chunk.map(p => {
                if (p.isOrphan) return [];
                const words = p.text.split(/\s+/).filter(w => w);
                let lastValidIndex = words.length;
                while (lastValidIndex > 0 && !hindiWordRegex.test(words[lastValidIndex - 1])) {
                    lastValidIndex--;
                }
                return words.slice(0, lastValidIndex);
            });

            let radeef = [];
            let radeefLength = 0;
            let isRadeefPure = true;
            const basePadWords = padWords[0];
            
            while (basePadWords.length > radeefLength) {
                const wordIndex = basePadWords.length - 1 - radeefLength;
                const potentialWord = basePadWords[wordIndex];
                const normalizedPotentialWord = normalizeForRadeef(potentialWord);
                
                let allMatch = true;
                for (let i = 1; i < padWords.length; i++) {
                    const otherPadWords = padWords[i];
                    if (otherPadWords.length <= radeefLength || normalizeForRadeef(otherPadWords[otherPadWords.length - 1 - radeefLength]) !== normalizedPotentialWord) {
                        allMatch = false;
                        break;
                    }
                }
                if (allMatch) {
                    radeef.unshift(potentialWord);
                    radeefLength++;
                    for (let i = 0; i < padWords.length; i++) {
                        if (padWords[i].length >= radeefLength && padWords[i][padWords[i].length - radeefLength] !== potentialWord) {
                            isRadeefPure = false;
                        }
                    }
                } else {
                    break;
                }
            }
            const baseRadeef = radeef.join(' ');
            
            const kaafiyaWords = [];
            let noKaafiyaWordError = false;
            for (const words of padWords) {
                if (words.length <= radeefLength) {
                    noKaafiyaWordError = true;
                    kaafiyaWords.push(null);
                } else {
                    kaafiyaWords.push(words[words.length - 1 - radeefLength]);
                }
            }

            let baseKaafiya = null;
            let kaafiyaValidationResult = { valid: false, reason: 'कोई काफ़िया शब्द नहीं मिला।' };

            if (!noKaafiyaWordError) {
                const allVarnas = kaafiyaWords.map(w => getVarnas(w));
                let commonSuffixVarnas = [];
                const minLength = Math.min(...allVarnas.map(v => v.length));
                
                for (let i = 1; i <= minLength; i++) {
                    const lastVarna = allVarnas[0][allVarnas[0].length - i];
                    if (allVarnas.every(v => v[v.length - i] === lastVarna)) {
                        commonSuffixVarnas.unshift(lastVarna);
                    } else {
                        break;
                    }
                }
                let kaafiyaCandidate = commonSuffixVarnas.join('');

                if (kaafiyaCandidate.length === 0 && kaafiyaWords.length > 0) {
                    const lastVowels = allVarnas.map(v => v.length > 0 ? getVowelOfVarna(v[v.length - 1]) : null);
                    if (lastVowels.every(v => v && v === lastVowels[0])) {
                        kaafiyaCandidate = lastVowels[0];
                    }
                } 
                else if (kaafiyaCandidate.length > 0) {
                    const suffixLength = commonSuffixVarnas.length;
                    const allHavePrecedingVarna = allVarnas.every(v => v.length > suffixLength);
                    if (suffixLength === 1 && allHavePrecedingVarna) {
                        const precedingVowels = allVarnas.map(v => getVowelOfVarna(v[v.length - suffixLength - 1]));
                        if (precedingVowels.every(v => v === precedingVowels[0])) {
                            kaafiyaCandidate = precedingVowels[0] + kaafiyaCandidate;
                        }
                    }
                }
                
                if (kaafiyaCandidate) {
                    baseKaafiya = kaafiyaCandidate;
                    kaafiyaValidationResult = validateKaafiya(baseKaafiya, baseRadeef);
                } else {
                     kaafiyaValidationResult.reason = 'काफ़िया शब्दों में कोई सामान्य वर्ण-अंश नहीं है।';
                }
            }

            let results = [];
            const overallRhymeStatus = kaafiyaValidationResult.valid;

            for (let i = 0; i < chunk.length; i++) {
                const kaafiyaWord = kaafiyaWords[i];
                if (!kaafiyaWord) {
                     results.push({ padIndex: chunk[i].padIndex, pad: chunk[i], status: 'fail', reason: 'कोई काफ़िया शब्द नहीं मिला।', kaafiyaWord: null, kaafiya: 'N/A', radeef: baseRadeef, isRadeefPure });
                     continue;
                }
                
                const status = (i === 0) ? 'base' : (overallRhymeStatus ? 'success' : 'fail');
                let reason = (i > 0) ? (overallRhymeStatus ? 'छंद के आधार से मेल खाता है।' : kaafiyaValidationResult.reason) : '';
                
                results.push({ padIndex: chunk[i].padIndex, pad: chunk[i], status, reason, kaafiyaWord, kaafiya: baseKaafiya || 'N/A', radeef: baseRadeef, isRadeefPure });
            }
            return { overallRhymeStatus, results, baseKaafiya, baseRadeef, isRadeefPure };
        }

        function generateAnalysisText() {
            let text = '🟥Analysis:\n';
            let rhymeDataIndex = 0;

            for (let i = 0; i < analysisData.pads.length; i += 4) {
                const chunkPads = analysisData.pads.slice(i, i + 4);
                const rhymeInfo = analysisData.rhymes[rhymeDataIndex];
                const startPad = i + 1;
                const endPad = i + chunkPads.length;

                text += `\nChhand ${rhymeDataIndex + 1}: (pad ${startPad} to pad ${endPad})\n`;

                let allVarnaCorrect = true;
                let varnaIssues = [];
                chunkPads.forEach(pad => {
                    if (pad.isOrphan) {
                        allVarnaCorrect = false;
                        varnaIssues.push(`pad ${pad.padIndex} adhoora hai`);
                    } else if (pad.count1 !== 16 || pad.count2 !== 15) {
                        allVarnaCorrect = false;
                        varnaIssues.push(`pad ${pad.padIndex} mein ${pad.count1},${pad.count2} hai`);
                    }
                });

                if (allVarnaCorrect) {
                    text += `✅ 16,15 varna count ko follow kiya hai har pad mein.\n`;
                } else {
                    text += `❌ ${varnaIssues.join(', ')}\n`;
                }

                if (rhymeInfo && chunkPads.length > 1) {
                    if (rhymeInfo.overallRhymeStatus) {
                        text += `✅ Rhyming bhi hai chaaro pad mein (Radeef: ${rhymeInfo.baseRadeef || 'koi nahi'}, Kafiya: ${rhymeInfo.baseKaafiya})\n`;
                    } else {
                        text += `❌ Pado ke beech rhyming nahi hai (Radeef: ${rhymeInfo.baseRadeef || 'koi nahi'}, Kafiya: ${rhymeInfo.baseKaafiya || 'N/A'})\n`;
                    }
                }
                rhymeDataIndex++;
            }
            return text;
        }
        
        function renderHTML() {
            resultsContainer.innerHTML = '';

            // Render individual pad analysis
            analysisData.pads.forEach(pad => {
                 if (pad.isOrphan) {
                    const orphanPadResult = document.createElement('div');
                    orphanPadResult.className = 'mb-6 p-5 bg-red-50 border border-red-200 rounded-lg shadow-sm';
                    orphanPadResult.innerHTML = `<p class="font-semibold text-red-700">पद ${pad.padIndex} अधूरा है। घनाक्षरी में प्रत्येक पद के दो भाग होने चाहिए।</p><p class="devanagari text-red-600 mt-2">${pad.lines[0]}</p>`;
                    resultsContainer.appendChild(orphanPadResult);
                    return;
                }
                
                const padResult = document.createElement('div');
                padResult.className = 'mb-6 p-5 bg-white border border-gray-200 rounded-lg shadow-sm animate-fade-in';
                let resultsHTML = `<h3 class="text-xl font-bold text-teal-700 border-b pb-2 mb-4 devanagari">पद ${pad.padIndex} का विश्लेषण</h3>`;
                resultsHTML += `<div class="space-y-3">`;
                resultsHTML += `<div class="p-3 bg-gray-50 rounded-md"><p class="devanagari text-lg">${pad.lines[0]} <span class="font-sans font-semibold text-teal-800 ml-2">➜ ${pad.count1} वर्ण</span></p></div>`;
                resultsHTML += `<div class="p-3 bg-gray-50 rounded-md"><p class="devanagari text-lg">${pad.lines[1]} <span class="font-sans font-semibold text-teal-800 ml-2">➜ ${pad.count2} वर्ण</span></p></div>`;
                resultsHTML += `</div><div class="mt-4 pt-4 border-t border-gray-200 space-y-2">`;
                resultsHTML += pad.totalCount === 31 ? `<p class="font-semibold text-green-700">✅ कुल योग: ${pad.totalCount} वर्ण (नियम के अनुसार)</p>` : `<p class="font-semibold text-red-700">❌ कुल योग: ${pad.totalCount} वर्ण (31 होने चाहिए)</p>`;
                resultsHTML += (pad.count1 === 16 && pad.count2 === 15) ? `<p class="font-semibold text-green-700">✅ यति विधान: 16, 15 (नियम के अनुसार)</p>` : `<p class="font-semibold text-red-700">❌ यति विधान: ${pad.count1}, ${pad.count2} (16, 15 होना चाहिए)</p>`;
                resultsHTML += pad.lastVarnaIsGuru ? `<p class="font-semibold text-green-700">✅ पदांत: अंतिम वर्ण गुरु है ('${pad.lastVarna}')</p>` : `<p class="font-semibold text-red-700">❌ पदांत: अंतिम वर्ण गुरु नहीं है ('${pad.lastVarna}')</p>`;
                resultsHTML += '</div>';
                padResult.innerHTML = resultsHTML;
                resultsContainer.appendChild(padResult);
            });

            // Render rhyme analysis
            analysisData.rhymes.forEach(chhandAnalysis => {
                if (chhandAnalysis.results.length < 2) return;

                const rhymeResultDiv = document.createElement('div');
                rhymeResultDiv.className = 'mt-8 mb-6 p-5 bg-indigo-50 border border-indigo-200 rounded-lg shadow-sm animate-fade-in';
                const startPad = chhandAnalysis.results[0].padIndex;
                const endPad = chhandAnalysis.results[chhandAnalysis.results.length - 1].padIndex;
                
                let rhymeHTML = `<h3 class="text-xl font-bold text-indigo-700 border-b border-indigo-200 pb-2 mb-4 devanari">तुकांतता विश्लेषण (पद ${startPad}-${endPad})</h3>`;
                rhymeHTML += `<div class="p-4 bg-white rounded-lg border">`;

                const { overallRhymeStatus, results, baseKaafiya, baseRadeef, isRadeefPure } = chhandAnalysis;

                if (baseKaafiya && baseKaafiya !== 'N/A') {
                    const radeefPurityNote = isRadeefPure ? '' : `<span class="text-orange-600 font-normal text-xs">(अशुद्ध रदीफ़)</span>`;
                    rhymeHTML += `<p class="text-sm mb-4 text-center"><strong>छंद का आधार:</strong> काफ़िया <span class="font-semibold text-blue-800 bg-blue-100 px-1.5 py-0.5 rounded">"${baseKaafiya}"</span>, रदीफ़ <span class="font-semibold text-green-800 bg-green-100 px-1.5 py-0.5 rounded">"${baseRadeef || 'कोई नहीं'}"</span> ${radeefPurityNote}</p>`;
                } else {
                     rhymeHTML += `<p class="text-sm text-red-600 mb-4 text-center">⚠️ इन पदों में तुकांतता नहीं मिली, इसलिए छंद का आधार स्थापित नहीं किया जा सका।</p>`;
                }
                const highlightLine = (line, kaafiyaWord, radeefStr) => {
                    if (!kaafiyaWord || !line) return line;
                    const lineEnd = (kaafiyaWord + ' ' + radeefStr).trim();
                    if (line.endsWith(lineEnd)) {
                        const mainPart = line.substring(0, line.length - lineEnd.length);
                        return `${mainPart}<span class="font-semibold text-blue-800 bg-blue-100 px-1.5 py-0.5 rounded">${kaafiyaWord}</span>` + (radeefStr ? ` <span class="font-semibold text-green-800 bg-green-100 px-1.5 py-0.5 rounded">${radeefStr}</span>` : '');
                    }
                    return line;
                };
                rhymeHTML += `<div class="space-y-5">`;
                results.forEach(res => {
                    const line = res.pad.lines[1] || res.pad.lines[0];
                    const highlightedLine = highlightLine(line, res.kaafiyaWord, res.radeef);
                    let statusIcon = res.status === 'base' ? '<span class="text-gray-500 font-bold">(आधार)</span>' : (res.status === 'success' ? '<span class="text-green-600 font-bold">✅ मेल खाता है</span>' : `<span class="text-red-600 font-bold">❌ मेल नहीं खाता</span>`);
                    
                    rhymeHTML += `<div class="border-t pt-3"><p class="font-semibold mb-2 text-gray-800">पद ${res.padIndex}: ${statusIcon}</p>`;
                    rhymeHTML += `<div class="p-3 bg-gray-50 rounded-md devanagari text-lg mb-2">${highlightedLine}</div>`;
                    rhymeHTML += `<div class="text-xs text-gray-700 space-y-1 border-l-2 border-indigo-100 pl-3 ml-1">`;
                    const radeefPurityNote = res.isRadeefPure ? '' : '<em class="text-orange-600 ml-1">(अनुस्वार/नुक़्ते के कारण अशुद्ध)</em>';
                    rhymeHTML += `<p><strong>रदीफ़:</strong> ${res.radeef ? `<span class="font-semibold text-green-800 bg-green-100 px-1 py-0.5 rounded">${res.radeef}</span>${radeefPurityNote}` : '<em>कोई नहीं</em>'}</p>`;
                    if (res.kaafiyaWord) {
                        const kaafiyaSound = res.kaafiya || 'N/A';
                        const kaafiyaCheckIcon = overallRhymeStatus ? '✅' : '❌';
                        rhymeHTML += `<p><strong>काफ़िया शब्द:</strong> <span class="font-semibold text-blue-800 bg-blue-100 px-1 py-0.5 rounded">${res.kaafiyaWord}</span> में काफ़िया "${kaafiyaSound}" की उपस्थिति ${kaafiyaSound === 'N/A' ? '❌' : kaafiyaCheckIcon}</p>`;
                    }
                    if (res.status !== 'base') rhymeHTML += `<p><strong>स्थिति:</strong> <em class="${res.status === 'fail' ? 'text-red-700' : 'text-green-700'}">${res.reason}</em></p>`;
                    rhymeHTML += `</div></div>`;
                });
                rhymeHTML += `</div>`;
                rhymeHTML += `<div class="mt-5 pt-4 border-t text-center">`;
                rhymeHTML += overallRhymeStatus && baseKaafiya && baseKaafiya !== 'N/A' ? `<p class="font-bold text-green-700">✅ इस छंद के सभी पद समतुकांत हैं।</p>` : `<p class="font-bold text-red-700">❌ इस छंद के सभी पद समतुकांत नहीं हैं।</p>`;
                rhymeHTML += `</div></div>`;
                rhymeResultDiv.innerHTML = rhymeHTML;
                resultsContainer.appendChild(rhymeResultDiv);
            });
        }

        function analyzeGhanakshari() {
            const text = textInput.value;
            const lines = text.split('\n').filter(line => line.trim() !== '');
            resultsContainer.innerHTML = '';
            copyContainer.style.display = 'none';
            analysisData = { pads: [], rhymes: [] };

            if (lines.length === 0) {
                resultsContainer.innerHTML = '<p class="text-center text-red-500">कृपया विश्लेषण के लिए कुछ टेक्स्ट दर्ज करें।</p>';
                return;
            }
            
            let allPads = [];
            for (let i = 0; i < lines.length; i += 2) {
                 if (i + 1 < lines.length) {
                    allPads.push({ text: `${lines[i].trim()} ${lines[i+1].trim()}`, lines: [lines[i], lines[i+1]] });
                 } else {
                     allPads.push({ text: lines[i].trim(), lines: [lines[i]], isOrphan: true });
                 }
            }

            allPads.forEach((pad, index) => {
                let padData = { padIndex: index + 1, ...pad };
                if (!pad.isOrphan) {
                    const part1 = pad.lines[0];
                    const part2 = pad.lines[1];
                    padData.count1 = countVarnas(part1);
                    padData.count2 = countVarnas(part2);
                    padData.totalCount = padData.count1 + padData.count2;
                    const allVarnas = getVarnas(pad.text);
                    padData.lastVarna = allVarnas.length > 0 ? allVarnas[allVarnas.length - 1] : null;
                    padData.lastVarnaIsGuru = isGuru(padData.lastVarna);
                }
                analysisData.pads.push(padData);
            });

            for (let i = 0; i < allPads.length; i += 4) {
                const chunk = allPads.slice(i, i + 4).map((p, idx) => ({ ...p, padIndex: i + 1 + idx }));
                if (chunk.length > 1) {
                    const rhymeAnalysis = analyzeChhandRhyme(chunk);
                    analysisData.rhymes.push(rhymeAnalysis);
                }
            }
            
            renderHTML();
            
            // Show the copy button if there are results
            if(analysisData.pads.length > 0){
                copyContainer.style.display = 'block';
            }
        }
        
        copyBtn.addEventListener('click', () => {
            const textToCopy = generateAnalysisText();
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            tempTextArea.style.position = 'absolute';
            tempTextArea.style.left = '-9999px';
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                copyFeedback.style.display = 'inline';
                setTimeout(() => { copyFeedback.style.display = 'none'; }, 2000);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                alert('विश्लेषण कॉपी करने में विफल रहा।');
            }
            document.body.removeChild(tempTextArea);
        });

        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade-in {
                animation: fadeIn 0.5s ease-in-out;
            }
        `;
        document.head.appendChild(style);

        analyzeBtn.addEventListener('click', analyzeGhanakshari);
    </script>

</body>
</html>
